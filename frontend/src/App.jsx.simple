import React, { useState, useEffect, useRef } from 'react';
import './App.css';

function App() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [agentType, setAgentType] = useState('rag'); // 'rag', 'advanced', or 'compare'
  const [threadId, setThreadId] = useState(null);
  const [showNewConversation, setShowNewConversation] = useState(false);
  const messagesEndRef = useRef(null);

  // Generate or retrieve thread ID
  useEffect(() => {
    if (!threadId) {
      const newThreadId = `thread-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      setThreadId(newThreadId);
      console.log('New thread created:', newThreadId);
    }
  }, [threadId]);

  // Auto-scroll to bottom
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!input.trim() || isLoading) return;

    const userInput = input;
    const userMessage = {
      text: userInput,
      sender: 'user',
      timestamp: new Date().toISOString()
    };

    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);

    try {
      // Determine which endpoint to use
      let endpoint;
      if (agentType === 'rag') {
        endpoint = '/api/rag_agent';
      } else if (agentType === 'advanced') {
        endpoint = '/api/advanced_rag_agent';
      } else {
        endpoint = '/api/compare';
      }

      console.log(`Sending request to ${endpoint} with thread_id: ${threadId}`);

      const response = await fetch(`http://localhost:8000${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          question: userInput,
          thread_id: threadId  // Include thread_id for memory
        }),
      });

      if (!response.ok) {
        throw new Error(`API call failed: ${response.status}`);
      }

      const data = await response.json();
      console.log('Response received:', data);

      // Handle response based on agent type
      if (agentType === 'compare') {
        // Show both agents' responses
        const botMessage = {
          text: `**RAG Agent:**\n${data.rag_agent.answer}\n\n**Advanced RAG Agent:**\n${data.advanced_rag_agent.answer}`,
          sender: 'bot',
          timestamp: new Date().toISOString(),
          metadata: {
            rag_latency: data.rag_agent.latency,
            advanced_latency: data.advanced_rag_agent.latency,
            rag_used_retrieval: data.rag_agent.used_retrieval,
            advanced_rewrites: data.advanced_rag_agent.num_rewrites
          }
        };
        setMessages(prev => [...prev, botMessage]);
      } else {
        // Single agent response
        const botMessage = {
          text: data.answer,
          sender: 'bot',
          timestamp: new Date().toISOString(),
          metadata: {
            latency: data.latency,
            used_retrieval: data.used_retrieval,
            num_rewrites: data.num_rewrites,
            thread_id: data.thread_id
          }
        };
        setMessages(prev => [...prev, botMessage]);
      }

      // Show new conversation button after first exchange
      if (messages.length === 0) {
        setShowNewConversation(true);
      }

    } catch (error) {
      console.error('Error:', error);
      const errorMessage = {
        text: `Error: ${error.message}`,
        sender: 'bot',
        timestamp: new Date().toISOString(),
        isError: true
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const startNewConversation = () => {
    const newThreadId = `thread-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    setMessages([]);
    setThreadId(newThreadId);
    setShowNewConversation(false);
    console.log('New conversation started with thread:', newThreadId);
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <h1>ü§ñ Agentic RAG with Memory</h1>
        <div className="agent-controls">
          <div className="agent-selector">
            <label className={agentType === 'rag' ? 'selected' : ''}>
              <input
                type="radio"
                value="rag"
                checked={agentType === 'rag'}
                onChange={(e) => setAgentType(e.target.value)}
              />
              RAG Agent
            </label>
            <label className={agentType === 'advanced' ? 'selected' : ''}>
              <input
                type="radio"
                value="advanced"
                checked={agentType === 'advanced'}
                onChange={(e) => setAgentType(e.target.value)}
              />
              Advanced RAG
            </label>
            <label className={agentType === 'compare' ? 'selected' : ''}>
              <input
                type="radio"
                value="compare"
                checked={agentType === 'compare'}
                onChange={(e) => setAgentType(e.target.value)}
              />
              Compare Both
            </label>
          </div>
          {showNewConversation && (
            <button onClick={startNewConversation} className="new-conversation-btn">
              üîÑ New Conversation
            </button>
          )}
        </div>
        <div className="thread-info">
          <span className="thread-label">Thread ID:</span>
          <span className="thread-id">{threadId?.substring(0, 20)}...</span>
        </div>
      </header>

      <main className="chat-container">
        <div className="messages">
          {messages.length === 0 && (
            <div className="welcome-message">
              <h2>Welcome to Agentic RAG!</h2>
              <p>This system has memory - it remembers your conversation within the same thread.</p>
              <p>Try asking questions and then follow-up questions to test the memory!</p>
              <div className="example-questions">
                <h3>Example conversation:</h3>
                <ul>
                  <li>"My name is Alice. What is Task Decomposition?"</li>
                  <li>"What is my name?" (should remember Alice)</li>
                  <li>"Can you give more details about that?" (should remember context)</li>
                </ul>
              </div>
            </div>
          )}

          {messages.map((message, index) => (
            <div key={index} className={`message ${message.sender} ${message.isError ? 'error' : ''}`}>
              <div className="message-bubble">
                <div className="message-content">
                  {message.text}
                </div>
                {message.metadata && (
                  <div className="message-metadata">
                    {message.metadata.latency !== undefined && (
                      <span className="metadata-item">
                        ‚è±Ô∏è {message.metadata.latency.toFixed(2)}s
                      </span>
                    )}
                    {message.metadata.rag_latency !== undefined && (
                      <>
                        <span className="metadata-item">
                          RAG: {message.metadata.rag_latency.toFixed(2)}s
                        </span>
                        <span className="metadata-item">
                          Adv: {message.metadata.advanced_latency.toFixed(2)}s
                        </span>
                      </>
                    )}
                    {message.metadata.used_retrieval !== undefined && (
                      <span className="metadata-item">
                        üìö Retrieval: {message.metadata.used_retrieval ? 'Yes' : 'No'}
                      </span>
                    )}
                    {message.metadata.num_rewrites !== undefined && message.metadata.num_rewrites > 0 && (
                      <span className="metadata-item">
                        ‚úèÔ∏è Rewrites: {message.metadata.num_rewrites}
                      </span>
                    )}
                    {message.metadata.advanced_rewrites !== undefined && message.metadata.advanced_rewrites > 0 && (
                      <span className="metadata-item">
                        ‚úèÔ∏è Rewrites: {message.metadata.advanced_rewrites}
                      </span>
                    )}
                  </div>
                )}
                <div className="message-time">
                  {new Date(message.timestamp).toLocaleTimeString()}
                </div>
              </div>
            </div>
          ))}

          {isLoading && (
            <div className="message bot">
              <div className="message-bubble">
                <div className="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          )}

          <div ref={messagesEndRef} />
        </div>

        <form onSubmit={handleSubmit} className="input-form">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder={messages.length === 0 ? "Try: 'My name is Bob. What is Task Decomposition?'" : "Ask a follow-up question..."}
            disabled={isLoading}
            className="input-field"
            autoFocus
          />
          <button type="submit" disabled={isLoading || !input.trim()} className="submit-btn">
            {isLoading ? '‚è≥' : 'üì§'} Send
          </button>
        </form>
      </main>
    </div>
  );
}

export default App;